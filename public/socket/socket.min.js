"use strict";var socket=io(),roomID=null,me={},hasChater=!1,pIdx=0,runIDs=[],tempSingle={},tempRoom={},audioMsgCome=new Audio("socket/mp3/didi.mp3"),audioJoinRoom=new Audio("socket/mp3/joinroom.mp3"),typeFacimg=["1.jpg","2.jpg","3.jpg","4.jpg","5.gif","6.jpg","7.jpg","8.gif","9.jpg","10.gif"],createChatContent=function(e,t,i,a){var n="";return n+='<li class="clearfix '+(a?"myself":"")+'">',n+='<img src="'+t+'" />',n+="<span>"+htmlEncode(e)+"</span>",n+='<div class="clearfix">',n+='<div class="chat-str">'+i+"</div>",n+="</div>",n+="</li>"},createEmoji=function(){var e="";e+="<div>";for(var t=1;t<=50;t++)e+='<a><img src="socket/images/face/'+t+'.gif" /></a>';return e+="</div>"},createFacimg=function(){var e="";e+="<div>";for(var t=0;t<typeFacimg.length;t++)e+='<a><img src="socket/images/facimg/'+typeFacimg[t]+'" /></a>';return e+="</div>"},getDivCont=function(e){return e.get(0).innerHTML},htmlEncode=function(e){var t=document.createElement("div");return null!=t.textContent?t.textContent=e:t.innerText=e,decodeURIComponent(t.innerHTML)},addChatHead=function(e,t,i,a,n){var o="";o+="<li>",o+='<img src="'+a+'" />',o+='<b class="ellipsis">'+htmlEncode(i)+"</b>",o+="<i>0</i>",o+='<span id="'+t+'"></span>',o+="</li>",$(".chater .tab-head ul").append(o),n&&$(".chater .tab-head ul li:last-child").click()},addChatone=function(e,t){var i="";i+='<div class="tab-one">',i+='<div class="tab-flex">',i+='<div class="chat-mid">',i+='<div class="chat-content">',i+="<ul>",i+="</ul>",i+="</div>",i+='<div class="chat-input">',i+='<div class="chat-fun">',i+='<ul class="clearfix">',i+='<li><i class="icon-smile"></i><input type="checkbox" /></li>',i+='<li><i class="icon-facimg"></i><input type="checkbox" /></li>',i+='<li><i class="icon-scissors"></i><input type="checkbox" /></li>',i+='<li><i class="icon-music"></i><input type="checkbox" />',i+='<div class="media-form"><p>\u53d1\u9001\u97f3\u4e50</p><input type="text" class="txt" name="source" datatype="music" placeholder="mp3\u7f51\u7edc\u5730\u5740" /><button class="icon icon-send"></button></div>',i+="</li>",i+='<li><i class="icon-image"></i><input type="checkbox" />',i+='<div class="media-form"><p>\u53d1\u9001\u56fe\u7247</p><input type="text" class="txt" name="source" datatype="image" placeholder="\u56fe\u7247\u5730\u5740" /><button class="icon icon-send"></button></div>',i+="</li>",i+='<li><i class="icon-film"></i><input type="checkbox" />',i+='<div class="media-form"><p>\u53d1\u9001\u89c6\u9891</p><input type="text" class="txt" name="source" datatype="video" placeholder="\u89c6\u9891\u7f51\u7edc\u5730\u5740" /><button class="icon icon-send"></button></div>',i+="</li>",i+="</ul>",i+="</div>",i+='<form class="sendMsgForm">',i+='<div class="input-wrapper">',i+='<div contenteditable="true" sendtype="'+e+'" sendid="'+t+'" class="textarea"></div>',i+='<button type="submit">SEND</button>',i+="</div>",i+="</form>",i+="</div>",i+="</div>",i+='<div class="chat-users">',i+="</div>",i+="</div>",i+="</div>",$(".chater .tab-body").append(i);var a=$(".chater .tab-body .tab-one:last-child");a.find(".chat-fun ul li").on("click",function(){$(this).siblings("li").find('input[type="checkbox"]').prop("checked",!1),$(this).children("div").length||(0===$(this).index()?$(this).append(createEmoji()):1===$(this).index()&&$(this).append(createFacimg()))}),a.on("click",".chat-fun ul li:eq(0) > div a",function(){$(this).closest(".chat-mid").find("div.textarea").get(0).focus();var e=$(this).clone(!0).html();window.getSelection();document.execCommand("insertHTML",!1,e),$(this).parent().prev("input").prop("checked",!1)}),a.on("click",".chat-fun ul li:eq(1) > div a",function(){var e=$(this).clone().html();$(this).parent().prev("input").prop("checked",!1),submitChat(e,$(this))}),a.on("keyup",'.chat-fun ul li input[type="text"]',function(e){var t=$(this);if(13===e.keyCode){var i=t.val(),a="";switch(t.attr("datatype")){case"music":a+='<audio src="'+i+'" controls="controls">\u60a8\u7684\u6d4f\u89c8\u5668\u4e0d\u652f\u6301 audio \u6807\u7b7e</audio>';break;case"image":a+='<img src="'+i+'" />';break;case"video":a+='<video src="'+i+'" controls="controls">\u60a8\u7684\u6d4f\u89c8\u5668\u4e0d\u652f\u6301 video \u6807\u7b7e</video>'}submitChat(a,t,function(){t.val(""),t.parent().prev("input").prop("checked",!1)})}})},addChatMsg=function(e,t,i){var a="";switch(e){case"datetime":break;case"broadcast":a+='<li class="broadcast">'+(htmlEncode(i.name)+" "+("join"===i.type?"\u8fdb\u5165\u804a\u5929\u5ba4":"\u79bb\u5f00\u804a\u5929\u5ba4"))+"</li>";break;case"content":var n=i.fromID===me.id;a=createChatContent(i.from.name,i.from.avator,i.txt,n)}$(".chater .tab-body .tab-one:eq("+t+") .chat-content ul").append(a),setTimeout(function(){var e=$(".chater .tab-body .tab-one:eq("+t+") .chat-content ul");e.scrollTop(e.get(0).scrollHeight)},100)},getSideInfo=function(e,n){var o="";o+="<div>","single"===e?(o+='<div><img src="socket/images/'+n.xiu+'.jpg" /></div>',o+="<h6>\u4e2a\u6027\u7b7e\u540d</h6>",o+="<p>"+n.sign+"</p>"):(o+="<ul>",Object.keys(n.users).forEach(function(e){var t=htmlEncode(n.users[e].name),i=n.users[e].avator,a=n.owner===e?'<i class="icon icon-single" title="\u7fa4\u4e3b"></i>':"";o+='<li userid="'+e+'"><img src="'+i+'" /><span>'+t+"</span>"+a+"</li>"}),o+="</ul>"),o+="</div>",$(".chater .tab-one:last-child .chat-users").append(o)},createChater=function(){if(!hasChater){hasChater=!0;var e="";e+='<div class="chater">',e+='<div class="chat-bar">',e+='<p><img src="'+me.avator+'" /> <b>'+htmlEncode(me.name)+"</b></p>",e+='<span class="fr icon icon-close"></span>',e+="</div>",e+='<div class="chat-main">',e+='<div class="tab">',e+='<div class="tab-head">',e+="<ul></ul>",e+="</div>",e+='<div class="tab-body">',e+="</div>",e+="</div>",e+="</div>",e+="</div>",$("body").append(e)}},newChatPanel=function(e,t,i,a){runIDs.push(t),"room"===e&&socket.emit("join room",t),createChater(),addChatone(e,t),addChatHead(e,t,i,a,!0),socket.emit("get info",e,t,!0)},submitChat=function(e,t,i){var a=runIDs[pIdx],n=new RegExp(/^room_.+/).test(a)?"room":"single";return"single"===n&&(t.closest(".chat-mid").find(".chat-content ul").append(createChatContent(me.name,me.avator,e,!0)),setTimeout(function(){var e=t.closest(".chat-mid").find(".chat-content ul");e.scrollTop(e.get(0).scrollHeight)},100)),socket.emit("chat",n,me.id,a,e),"function"==typeof i&&i(),!1};$(function(){$("body").on("keyup","div.textarea",function(e){if(e.ctrlKey&&13===e.keyCode){var t=$(this);if(t.get(0).hasChildNodes()){var i=getDivCont($(this));submitChat(i,t,function(){t.empty()})}}}),$("body").on("click",".chater .tab-head li",function(e){if(!$(this).hasClass("cur")){$(this).addClass("cur").siblings("li").removeClass("cur"),$(this).find("i").removeClass("vis").text(0);var t=$(this).index();pIdx=t,$(".chater .tab-body .tab-one").eq(t).addClass("cur").siblings(".tab-one").removeClass("cur")}}),$("#rooms").on("click","ul.roomlist li a",function(){var n=$(this).attr("roomid"),e=_.indexOf(runIDs,n),o=$(this).find("p").text(),s=$(this).find("img").attr("src");-1<e?$(".chater .tab-head li").eq(e).click():$(this).hasClass("secret")?ceng.hello({title:"\u804a\u5929\u5ba4\u9080\u8bf7\u7801",content:$("#divRoomSecret"),contentType:"dom",area:[480,240],complete:function(e,t){var i=new Valid,a=$("#formRoomSecret");i.form(a,{isAsync:!0,asyncFun:function(){socket.emit("valid room secret",{secret:e.find("#iptSecret").val(),roomID:n,toName:o,toAvator:s}),ceng.close(t)},errFun:function(){e.find(".ceng-btn .btn").removeClass("disabled")}})},yes:function(e,t){$("#formRoomSecret").submit()}}):newChatPanel("room",n,o,s)}),$("body").on("click",".chater .chat-users ul li",function(){var e=$(this).attr("userid"),t=_.indexOf(runIDs,e);if(e!==me.id)if(-1<t)$(".chater .tab-head li").eq(t).click();else{var i=$(this).find("span").text(),a=$(this).find("img").attr("src");newChatPanel("single",e,i,a)}else ceng.alert("\u70b9\u51fb\u81ea\u5df1\u5f39\u51fa\u4e2a\u4eba\u4fe1\u606f\u9762\u677f")}),$("#setNameForm").on("submit",function(e){return e.preventDefault(),socket.emit("set user",{name:$("#iptName").val()}),$("#iptName").val(""),!1}),$("#rooms .panel #addRoom").on("click",function(){ceng.hello({title:"\u521b\u5efa\u7fa4\u7ec4",content:$("#divNewRoom"),contentType:"dom",area:[480,380],complete:function(e,t){var i=new Valid,a=$("#formNewRoom");i.form(a,{isAsync:!0,asyncFun:function(){var e={};e.name=a.find('input[name="name"]').val(),e.switch=a.find('input[name="switch"]').val(),e.secret=a.find('input[name="secret"]').val(),socket.emit("new room",e),ceng.close(t)},errFun:function(){e.find(".ceng-btn .btn").removeClass("disabled")}}),e.find("#switchCode").switchSmart({enable:function(){$("#rowSecret").addClass("slide required"),$("#roomSecret").addClass("txt").attr("data-req",!0)},disable:function(){$("#rowSecret").removeClass("slide required"),$("#roomSecret").val("").removeClass("txt").attr("data-req",!1)}})},yes:function(e,t){$("#formNewRoom").submit()}})}),$("#formSearch input").on("focus",function(){$(".panel-search").addClass("focus")}).on("blur",function(){$(".panel-search").removeClass("focus")}),$("body").on("click",".icon-close",function(){}),$("#rooms i.nail").on("click",function(){$("#rooms").toggleClass("faint")})}),socket.on("name comflict",function(e){ceng.msger(e,0)}),socket.on("save me",function(e){me=e,$("#setname").fadeOut("250"),$("#shadow").fadeOut("250"),$("#myInfo img").attr("src",e.avator),$("#myInfo span").text(e.name),$("#myInfo p").text(e.sign)}),socket.on("show rooms",function(i){var a="";Object.keys(i).forEach(function(e,t){a+="<li>",a+='<a class="clearfix '+(i[e].isSecret?"secret":"")+'" roomid="'+e+'">',a+='<i class="icon icon-lock-closed"></i>',a+='<img src="'+i[e].avator+'" />',a+='<p class="ellipsis">'+htmlEncode(i[e].name)+"</p>",a+='<span class="ellipsis">ID：'+e+"</span>",a+="</a>",a+="</li>"}),$("#rooms").toggleClass("empty",Object.keys(i).length<1),$("#rooms ul.roomlist").empty().append(a)}),socket.on("message",function(e){ceng.msger(e,0)}),socket.on("get info",function(e){"single"===e.type?e.render&&getSideInfo("single",e):"room"===e.type&&e.render&&getSideInfo("room",e)}),socket.on("valid room secret",function(e){var t=e.roomID,i=e.toName,a=e.toAvator;newChatPanel("room",t,i,a)}),socket.on("new room",function(e){var t=e.roomID,i=e.name,a=e.avator,n="";n+="<li>",n+='<a class="clearfix '+(e.isSecret?"secret":"")+'" roomid="'+t+'">',n+='<i class="icon icon-lock-closed"></i>',n+='<img src="'+a+'">',n+='<p class="ellipsis">'+htmlEncode(decodeURIComponent(i))+"</p>",n+='<span class="ellipsis">ID：'+t+"</span>",n+="</a>",n+="</li>",$("#rooms .panel .roomlist").append(n)}),socket.on("broadcast join room",function(e){var t=e.roomID,i=e.user,a=e.newcomeID,n=_.indexOf(runIDs,t);addChatMsg("broadcast",n,{type:"join",name:i.name}),audioJoinRoom.play(),$(".chater .tab-one:eq("+n+") .chat-users ul").append('<li userid="'+a+'"><img src="'+i.avator+'" /><span>'+htmlEncode(i.name)+"</span></li>")}),socket.on("broadcast leave room",function(e){var t=e.roomID,i=e.user,a=_.indexOf(runIDs,t);addChatMsg("broadcast",a,{type:"leave",name:i.name}),$(".chater .chat-users ul li").each(function(){$(this).find("span").text()===i.name&&$(this).remove()})}),socket.on("chat",function(e){var t=e.receiveID,i=e.from,a=e.txt,n=e.fromID,o=_.indexOf(runIDs,t);if(-1===o&&(createChater(),runIDs.push(t),addChatone("single",t),addChatHead("single",t,i.name,i.avator),o=runIDs.length-1,socket.emit("get info","single",t,!0)),hasChater&&pIdx!=o){var s=$(".chater .tab-head li").eq(o).find("i");parseInt(s.text());s.addClass("vis").text(parseInt(s.text())+1)}me.id!=n&&audioMsgCome.play(),addChatMsg("content",o,{fromID:n,from:i,txt:decodeURIComponent(a)})});